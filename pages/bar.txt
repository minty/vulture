<h1>hello world</h1>

<input id=join  type=button value=join>
<input id=leave type=button value=leave>
<input id=work  type=button value=work>
<input id=stop  type=button value=stop>
<p>current working state: <span id=msg></span></p>

<div id=log></div>

<script type="text/javascript">
  $(function() {

    function GUID () {
        var S4 = function () {
            return Math.floor(
                Math.random() * 0x10000 /* 65536 */
            ).toString(16);
        };
        return (S4() + S4() + '-' + S4() + S4() + '-' + S4() + S4());
    }
    if (!localStorage.guid) localStorage.guid = GUID();
    var sessionid = GUID();

    var working = false;
    var timer;

    function do_work() {
        if (!working) {
            clearTimeout(timer);
            return;
        }
        var start = (new Date).getTime();
        $.ajax('/api/task/get', {
            'data': {
                'guid':      localStorage.guid,
                'sessionid': sessionid,
            },
            'success': function(data) {
                if (data.run) {
                    var script = $('<script class=autoscript type="text/javascript"><' + '/script>');
                    script.text( data.run.task.test );
                    var msg = '';
                    try {
                        $('body').append(script);
                        msg = 'hardwired result text';
                        $('.autoscript').remove();
                    } catch(e) {
                        msg = 'FAILED';
                    }
                    send_result(
                        data.run.task.id,
                        data.run.task.clienttask_id,
                        msg
                    );
                }
                else if (data.error) {
                    console.log(data.error.slug);
                }
                else if (data.retry == 1) {
                    // do nothing, just return & we'll poll for more work
                }
                else {
                    console.log('Unexpected response to api/task/get');
                    console.log(data);
                }
                do_work();
            },
            'error': function(jqXHR, textStatus) {
                timer = setTimeout(do_work, 60000);
            }
        });
    }

    function send_result(task_id, clienttask_id, result) {
        $.ajax('/api/task/done', {
            'data'   : {
                'task_id'      : task_id,
                'clienttask_id': clienttask_id,
                'result'       : result,
                'guid'         : localStorage.guid,
                'sessionid'    : sessionid
            },
            'success': function(data) {
                $('.autoscript').remove();
            }
        });
    }

    $('#work').on('click', function(e) {
        if (working) return;
        working = true;
        $('#msg').text(working);
        do_work();
    });
    $('#stop').on('click', function(e) {
        working = false;
        $('#msg').text(working);
    });

    $('#join').on('click', function(e) {
        $.ajax('/api/client/join/', {
            'data': {
                'guid':      localStorage.guid,
                'sessionid': sessionid,
            },
            'success': function(data) {
                alert(typeof data.joined != 'undefined' ? 'joined' : 'failed');
            }
        });
    });

    $('#leave').on('click', function(e) {
        $.ajax('/api/client/leave/', {
            'data': {
                'guid':      localStorage.guid,
                'sessionid': sessionid,
            },
            'success': function(data) {
                alert(typeof data.left != 'undefined' ? 'left' : 'failed');
            }
        });
    });

  });
</script>
