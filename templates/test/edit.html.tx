[% WRAPPER "_page.tx" WITH body_class = 'testedit', type = 'index' %]

<iframe src="[% api_base() %]/task/list/complete"></iframe>

<h1>Edit test</h1>

<div>test id: <input type=text name=id value="[% id %]"></div>
<div>test url: <input type=text name=url value="http://192.168.58.100:8899[% api_base() %]task/list/complete"></div>

<textarea name=test rows=20 cols=70>[% test %]</textarea>

<p>
<input type=button value=run>
<input type=button id=lar value="load &amp; run">
<input type=button value=save>
<span id=console></span>
</p>

<div>
</div>

<script type="text/javascript">
    function l(m) { console.log(m) }
    function run_tests() {
        l('finished loading, running tests');
        var id     = $('input[name="id"]').val();
        var tests  = $('textarea');
        var iframe = $('iframe');
        var target = $( iframe.get(0).contentWindow.document );
        var frame_head = $('head',target).get(0);
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.class = 'autoscript';
        script.textContent = tests.val();
        frame_head.appendChild(script);
        l('finished running tests');
        var dt = new Date;
        $('#console')
            .text(id + ' run at ' + dt)
            .fadeIn();
    }
  $(function() {

    var save_btn = $('input[value="save"]');
    var run_btn  = $('input[value="run"]');
    var lar_btn  = $('#lar');
    run_btn.on('click', function(e) {
        run_btn.val('running');
        $('#console').hide();

        var url = $('input[name="url"]').val();
        l( "Loading " + url );
        run_tests();
        run_btn.val('run');
    });
    lar_btn.on('click', function(e) {

        lar_btn.val('loading');
        $('#console').hide();

        var id     = $('input[name="id"]').val();
        var url    = $('input[name="url"]').val();
        var iframe = $('iframe');
        l( "Loading " + url );

        iframe.attr('src', url );
        iframe.load(function() {
            lar_btn.val('running');
            run_tests();
            lar_btn.val('load & run');
        });
    });

    save_btn.on('click', function(e) {

        save_btn.val('saving');
        $('#console').hide();
        var js  = $('textarea').val();
        var id  = $('input[name="id"]').val();
        var url = $('input[name="url"]').val();

        console.log(id);
        console.log(url);
        console.log(js);

        $.ajax('[% api_base() %]/api/test/save/' + id, {
            'data': {
                'test_js': js,
                'url'    : url,
            },
            'success': function(data) {
                var dt = new Date;
                $('#console')
                    .text(id + ' saved at ' + dt)
                    .fadeIn();
                save_btn.val('save');
            },
            'error': function(xhr, status) {
                console.log('error saving test ' + id + ' ' + status);
            }
        });
    });
  });
</script>
[% END %]
